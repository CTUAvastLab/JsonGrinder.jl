<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Mutagenesis Example · JsonGrinder.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.svg" alt="JsonGrinder.jl logo"/><img class="docs-dark-only" src="../../assets/logo-dark.svg" alt="JsonGrinder.jl logo"/></a><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../schema/">Schema</a></li><li><a class="tocitem" href="../../extractors/">Creating extractors</a></li><li><a class="tocitem" href="../../exfunctions/">Extractors overview</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Mutagenesis Example</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Create-the-model"><span>Create the model</span></a></li><li class="toplevel"><a class="tocitem" href="#Train-the-model"><span>Train the model</span></a></li><li class="toplevel"><a class="tocitem" href="#Classify-test-set"><span>Classify test set</span></a></li></ul></li><li><a class="tocitem" href="../recipes/">Recipe Ingredients Example</a></li></ul></li><li><a class="tocitem" href="../../automl/">AutoML</a></li><li><a class="tocitem" href="../../hierarchical/">External tools</a></li><li><a class="tocitem" href="../../api/">API Documentation</a></li><li><a class="tocitem" href="../../developers/">Developers</a></li><li><a class="tocitem" href="../../citation/">Citation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Mutagenesis Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Mutagenesis Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CTUAvastLab/JsonGrinder.jl/blob/master/examples/mutagenesis.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Mutagenesis-Example"><a class="docs-heading-anchor" href="#Mutagenesis-Example">Mutagenesis Example</a><a id="Mutagenesis-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Mutagenesis-Example" title="Permalink"></a></h1><p>Following example demonstrates learning to <a href="https://relational.fit.cvut.cz/dataset/Mutagenesis">predict the mutagenicity on Salmonella typhimurium</a> (dataset is stored in json format <a href="https://juliaml.github.io/MLDatasets.jl/stable/datasets/Mutagenesis/">in MLDatasets.jl</a> for your convenience).</p><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>This example is also available as a Jupyter notebook: <a href="https://nbviewer.jupyter.org/github/CTUAvastLab/JsonGrinder.jl/blob/gh-pages/previews/PR101/examples/mutagenesis.ipynb"><code>mutagenesis.ipynb</code></a></p></div></div><pre><code class="language-julia hljs">using MLDatasets, JsonGrinder, Flux, Mill, MLDataPattern, Statistics, ChainRulesCore</code></pre><p>start by loading all samples</p><pre><code class="language-julia hljs">train_x, train_y = MLDatasets.Mutagenesis.traindata();
test_x, test_y = MLDatasets.Mutagenesis.testdata();
minibatchsize = 100
iterations = 5_000
neurons = 20 		# neurons per layer</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">20</code></pre><p>Create the schema and extractor from training data</p><pre><code class="language-julia hljs">sch = JsonGrinder.schema(train_x)
extractor = suggestextractor(sch)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict
  ├─── lumo: Categorical d = 99
  ├─── inda: Categorical d = 2
  ⋮
  └── atoms: Array of
               └── Dict
                     ⋮</code></pre><p>Convert samples to Mill structure and extract targets</p><pre><code class="language-julia hljs">train_data = extractor.(train_x)
test_data = extractor.(test_x)
labelnames = unique(train_y)

@show train_data[1]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ProductNode 	# 1 obs, 104 bytes
  ├─── lumo: ArrayNode(99×1 OneHotArray with Bool elements) 	# 1 obs, 60 bytes
  ├─── inda: ArrayNode(2×1 OneHotArray with Bool elements) 	# 1 obs, 60 bytes
  ├─── logp: ArrayNode(63×1 OneHotArray with Bool elements) 	# 1 obs, 60 bytes
  ├─── ind1: ArrayNode(3×1 OneHotArray with Bool elements) 	# 1 obs, 60 bytes
  └── atoms: BagNode 	# 1 obs, 136 bytes
               └── ProductNode 	# 26 obs, 64 bytes
                     ⋮</code></pre><h1 id="Create-the-model"><a class="docs-heading-anchor" href="#Create-the-model">Create the model</a><a id="Create-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-the-model" title="Permalink"></a></h1><pre><code class="language-julia hljs">model = reflectinmodel(sch, extractor,
	layer -&gt; Dense(layer, neurons, relu),
	bag -&gt; SegmentedMeanMax(bag),
	fsm = Dict(&quot;&quot; =&gt; layer -&gt; Dense(layer, length(labelnames))),
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ProductModel ↦ ArrayModel(Dense(100, 2)) 	# 2 arrays, 202 params, 888 bytes
  ├─── lumo: ArrayModel(Dense(99, 20, relu)) 	# 2 arrays, 2_000 params, 7.891 KiB
  ├─── inda: ArrayModel(Dense(2, 20, relu)) 	# 2 arrays, 60 params, 320 bytes
  ├─── logp: ArrayModel(Dense(63, 20, relu)) 	# 2 arrays, 1_280 params, 5.078 KiB
  ├─── ind1: ArrayModel(Dense(3, 20, relu)) 	# 2 arrays, 80 params, 400 bytes
  └── atoms: BagModel ↦ [SegmentedMean(20); SegmentedMax(20)] ↦ ArrayModel(Dense(40, 20, relu)) 	# 4 arrays, 860 params, 3.516 KiB
               └── ProductModel ↦ ArrayModel(Dense(61, 20, relu)) 	# 2 arrays, 1_240 params, 4.922 KiB
                     ⋮</code></pre><h1 id="Train-the-model"><a class="docs-heading-anchor" href="#Train-the-model">Train the model</a><a id="Train-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Train-the-model" title="Permalink"></a></h1><p>let&#39;s define loss and some helper functions</p><pre><code class="language-julia hljs">loss(x,y) = Flux.logitcrossentropy(inference(x), Flux.onehotbatch(y, labelnames))
inference(x::AbstractMillNode) = model(x).data
inference(x::AbstractVector{&lt;:AbstractMillNode}) = inference(reduce(catobs, x))
accuracy(x,y) = mean(labelnames[Flux.onecold(inference(x))] .== y)
loss(xy::Tuple) = loss(xy...)
@non_differentiable Base.reduce(catobs, x::AbstractVector{&lt;:AbstractMillNode})
cb = () -&gt; begin
	train_acc = accuracy(train_data, train_y)
	test_acc = accuracy(test_data, test_y)
	println(&quot;accuracy: train = $train_acc, test = $test_acc&quot;)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">#9 (generic function with 1 method)</code></pre><p>create minibatches</p><pre><code class="language-julia hljs">minibatches = RandomBatches((train_data, train_y), size = minibatchsize, count = iterations)
Flux.Optimise.train!(loss, Flux.params(model), minibatches, ADAM(), cb = Flux.throttle(cb, 2))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">accuracy: train = 0.6, test = 0.6818181818181818
accuracy: train = 0.7, test = 0.7045454545454546
accuracy: train = 0.78, test = 0.8636363636363636
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.82, test = 0.8863636363636364
accuracy: train = 0.83, test = 0.8636363636363636
accuracy: train = 0.85, test = 0.8636363636363636
accuracy: train = 0.85, test = 0.8636363636363636
accuracy: train = 0.85, test = 0.8636363636363636
accuracy: train = 0.85, test = 0.8636363636363636
accuracy: train = 0.86, test = 0.8636363636363636
accuracy: train = 0.88, test = 0.8636363636363636
accuracy: train = 0.88, test = 0.8636363636363636
accuracy: train = 0.89, test = 0.8636363636363636
accuracy: train = 0.89, test = 0.8636363636363636
accuracy: train = 0.91, test = 0.8636363636363636
accuracy: train = 0.91, test = 0.8409090909090909
accuracy: train = 0.91, test = 0.8636363636363636
accuracy: train = 0.91, test = 0.8409090909090909
accuracy: train = 0.91, test = 0.8409090909090909
accuracy: train = 0.91, test = 0.8181818181818182
accuracy: train = 0.91, test = 0.8181818181818182
accuracy: train = 0.92, test = 0.8181818181818182
accuracy: train = 0.93, test = 0.8181818181818182
accuracy: train = 0.92, test = 0.8181818181818182
accuracy: train = 0.93, test = 0.8181818181818182
accuracy: train = 0.93, test = 0.8181818181818182</code></pre><h1 id="Classify-test-set"><a class="docs-heading-anchor" href="#Classify-test-set">Classify test set</a><a id="Classify-test-set-1"></a><a class="docs-heading-anchor-permalink" href="#Classify-test-set" title="Permalink"></a></h1><pre><code class="language-julia hljs">probs = softmax(inference(test_data))
o = Flux.onecold(probs)
pred_classes = labelnames[o]
print(mean(pred_classes .== test_y))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.8181818181818182</code></pre><p>we see the accuracy is around 79% on test set</p><pre><code class="language-julia hljs">#predicted classes for test set
print(pred_classes)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0]</code></pre><p>gt classes for test set</p><pre><code class="language-julia hljs">print(test_y)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1]</code></pre><p>probabilities for test set</p><pre><code class="language-julia hljs">print(probs)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Float32[0.8067001 0.055362698 0.8323501 0.04140845 0.048417773 0.79643655 0.051438488 0.046752494 0.7239757 0.8291928 0.8284415 0.07158942 0.042432554 0.8707087 0.83135617 0.046782136 0.8252199 0.055577375 0.054814775 0.0467861 0.15440248 0.4279053 0.6106487 0.78154814 0.015652677 0.63068646 0.56369215 0.30059874 0.96783173 0.8398204 0.7563754 0.06264025 0.021983452 0.031218886 0.82412964 0.8358364 0.9886905 0.8241201 0.79217356 0.0553121 0.6424376 0.84023595 0.7986205 0.37574568; 0.19329996 0.9446373 0.1676499 0.9585916 0.9515822 0.20356342 0.94856143 0.95324755 0.2760243 0.17080717 0.17155845 0.92841053 0.95756745 0.12929131 0.16864385 0.95321786 0.17478009 0.9444226 0.94518524 0.9532139 0.8455975 0.5720947 0.38935128 0.21845184 0.98434734 0.36931357 0.43630788 0.6994013 0.032168306 0.1601796 0.24362467 0.9373598 0.9780165 0.9687811 0.17587033 0.16416357 0.011309509 0.17587985 0.20782647 0.94468796 0.3575624 0.15976407 0.20137948 0.6242543]</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../exfunctions/">« Extractors overview</a><a class="docs-footer-nextpage" href="../recipes/">Recipe Ingredients Example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.10 on <span class="colophon-date" title="Thursday 25 November 2021 10:56">Thursday 25 November 2021</span>. Using Julia version 1.6.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
